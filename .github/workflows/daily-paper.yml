name: AI Paper Daily Push

on:
  # 每天中午12点（UTC时间4点 = 北京时间12点）
  schedule:
    - cron: '0 4 * * *'

  # 手动触发，支持参数覆盖
  workflow_dispatch:
    inputs:
      max_papers:
        description: '论文数量'
        default: '6'
      max_blogs:
        description: '博客数量'
        default: '3'
      categories:
        description: '类别过滤（逗号分隔，留空=默认）'
        default: ''
      enable_ai_summary:
        description: '启用 AI 摘要'
        type: boolean
        default: true

jobs:
  paper-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run paper pusher
        env:
          FEISHU_WEBHOOK_URLS: ${{ secrets.FEISHU_WEBHOOK_URLS || secrets.FEISHU_WEBHOOK_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: https://api.gpt.ge
          OPENAI_MODEL: gpt-4o
          AI_PROVIDER: openai
          HF_ENABLE_AI_SUMMARY: ${{ github.event.inputs.enable_ai_summary || 'true' }}
          HF_DAYS_BACK: "7"
          HF_MAX_PAPERS: ${{ github.event.inputs.max_papers || '6' }}
          HF_MAX_BLOGS: ${{ github.event.inputs.max_blogs || '3' }}
          HF_CATEGORIES: ${{ github.event.inputs.categories || 'vlm_data_strategy,data_engineering,training_data_strategy,data_methodology,vision_language,alignment' }}
          HF_INCLUDE_CLASSIC: "true"
        run: python3 hf_papers_advanced.py

      - name: Retry on failure
        if: failure()
        env:
          FEISHU_WEBHOOK_URLS: ${{ secrets.FEISHU_WEBHOOK_URLS || secrets.FEISHU_WEBHOOK_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: https://api.gpt.ge
          OPENAI_MODEL: gpt-4o
          AI_PROVIDER: openai
          HF_ENABLE_AI_SUMMARY: "false"
          HF_DAYS_BACK: "7"
          HF_MAX_PAPERS: ${{ github.event.inputs.max_papers || '6' }}
          HF_MAX_BLOGS: "0"
          HF_CATEGORIES: ${{ github.event.inputs.categories || 'vlm_data_strategy,data_engineering,training_data_strategy,data_methodology,vision_language,alignment' }}
          HF_INCLUDE_CLASSIC: "true"
        run: |
          echo "First attempt failed, retrying with AI summary disabled..."
          sleep 10
          python3 hf_papers_advanced.py

      - name: Notify Feishu on failure
        if: failure()
        env:
          FEISHU_WEBHOOK_URLS: ${{ secrets.FEISHU_WEBHOOK_URLS || secrets.FEISHU_WEBHOOK_URL }}
        run: |
          for url in $FEISHU_WEBHOOK_URLS; do
            curl -s -X POST "$url" \
              -H 'Content-Type: application/json' \
              -d '{"msg_type":"text","content":{"text":"⚠️ GitHub Actions AI Paper Daily Push 失败\n\n请检查: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}}'
          done
